#!/usr/bin/env python3
import os
import sys
from pathlib import Path

def main():
    root = Path(os.environ.get('MASHFS_ROOT', 'filesfs')).absolute()
    current_dir = os.environ.get('MASHFS_CWD', 'home/mash')
    
    argc = len(sys.argv)
    if argc < 2:
        home_dir = f"home/{os.environ.get('USER', 'mash')}"
        if (root / home_dir).exists():
            os.environ['MASHFS_CWD'] = home_dir
            print(f"Changed directory to {home_dir}")
        return 0
        
    path = sys.argv[1]
    
    if path == '-':
        print("cd: OLDPWD not set", file=sys.stderr)
        return 1
    
    if path.startswith('/'):
        # Абсолютный путь в MashFS
        new_path = path.lstrip('/')
    else:
        # Относительный путь
        if path == '..':
            if current_dir == '' or current_dir == '/':
                new_path = ''
            else:
                parts = current_dir.split('/')
                new_path = '/'.join(parts[:-1])
        elif path == '.':
            new_path = current_dir
        else:
            # Обработка составных путей с '..' и '.'
            parts = current_dir.split('/')
            for part in path.split('/'):
                if part == '' or part == '.':
                    continue
                elif part == '..':
                    if parts:
                        parts.pop()
                else:
                    parts.append(part)
            new_path = '/'.join(parts)
    
    target_path = root / new_path
    
    try:
        real_path = target_path.resolve()
        if not str(real_path).startswith(str(root)):
            print(f"cd: {path}: Access denied (cannot leave MashFS root)", file=sys.stderr)
            return 1
            
        if not real_path.exists():
            print(f"cd: {path}: No such file or directory", file=sys.stderr)
            return 1
        elif not real_path.is_dir():
            print(f"cd: {path}: Not a directory", file=sys.stderr)
            return 1
        elif not os.access(real_path, os.R_OK):
            print(f"cd: {path}: Permission denied", file=sys.stderr)
            return 1
        
        os.environ['MASHFS_CWD'] = new_path
        print(f"Changed directory to {new_path}")
    except Exception as e:
        print(f"cd: {path}: {e}", file=sys.stderr)
        return 1
    
    return 0

if __name__ == "__main__":
    sys.exit(main()) 
